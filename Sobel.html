<HTML>
<BODY>
<canvas width="500" height="500" id="lab01">
</canvas>

<canvas width="500" height="500" id="lab02">
</canvas>
<script>
    var canvas = document.getElementById("lab01");
    var ctx = canvas.getContext("2d");

    var canvas2 = document.getElementById("lab02");
    var ctx2 = canvas2.getContext("2d");

    function matrixOperation(ourMatrix, defaultMatrix, size) {
        let res = 0;
        for (let i = 0; i < size; ++i) {
            for (let j = 0; j < size; ++j) {
                res += ourMatrix[i][j] * defaultMatrix[i][j];
            }
        }
        return res;
    }

    function doubleMatrixOperation(ourMatrix, defaultMatrix1, defaultMatrix2, size) {
        let a = matrixOperation(ourMatrix, defaultMatrix1, size);
        let b = matrixOperation(ourMatrix, defaultMatrix2, size);
        return Math.sqrt(a * a + b * b);
    }

    function massiveToMatrix(img_data_massive, startIndex) {
        let matrix = [];
        for (let i = 0; i < canvas.width; ++i) {
            matrix[i] = [];
        }
        for (let i = 0; i < canvas.height; ++i) {
            for (let j = 0; j < canvas.width; ++j) {
                matrix[i][j] = img_data_massive[startIndex + i * canvas.width + 4 * j];
            }
        }
        return matrix;
    }

    function matrixCreation(img_data_matrix, startIndex, size, x, y) {
        let matrix = [];
        for (let i = 0; i < size; ++i) {
            matrix[i] = [];
            for (let j = 0; j < size; ++j) {
                if (x + j > 0 && x + j - 1 < canvas.width && y + i > 0 && y + i - 1 < canvas.height) {
                    matrix[i][j] = img_data_matrix[y + i - 1][x + j - 1];
                    // console.log(img_data_massive[startIndex + j]);
                } else {
                    matrix[i][j] = 0;
                }
            }
        }
        return matrix;
    }

    function Sobel1(img_data, defaultMatrix1, defaultMatrix2, startIndex, newImgData) {
        let imgMatrix = massiveToMatrix(img_data.data, startIndex);
        let x = 0;
        let y = 0;
        for (let i = startIndex; i < img_data.data.length; i += 4) {
            let matrix = matrixCreation(imgMatrix, i, 3, x, y);
            if (x !== canvas.width - 1) {
                ++x;
                //console.log("x ", x, ", y ", y, "  ", matrix);
            } else {
                ++y;
                x = 0;
                //console.log("y ", y, "   ", matrix);
            }
            newImgData[i] = doubleMatrixOperation(matrix, defaultMatrix1, defaultMatrix2, 3);
        }
        console.log(newImgData);
    }

    function Sobel(img_data) {
        let defaultMatrix1 = [[-1, 0, 1], [-2, 0, 2], [-1, 0, 1]];
        let defaultMatrix2 = [[-1, -2, -1], [0, 0, 0], [1, 2, 1]];
        let newImgData = ctx.createImageData(canvas.width, canvas.height);
        for (let i = 0; i < img_data.data.length; ++i) {
            newImgData.data[i] = img_data.data[i];
        }
        console.log("base ",img_data.data);
        console.log("copied ", newImgData.data);
        for (let i = 0; i < 3; ++i) {
            Sobel1(img_data, defaultMatrix1, defaultMatrix2, i, newImgData.data);
        }
        console.log("final ", newImgData.data);
        ctx2.putImageData(newImgData, 0, 0);
    }

    let img = new Image;
    img.crossOrigin = 'Anonymous';
    img.src = 'https://raw.githubusercontent.com/ekildishev/graphics-lab04/master/e3478a723d21401f3a4ad4832dd4c827.jpg';
    img.onload = function () {
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        let img_data = ctx.getImageData(0, 0, canvas.width, canvas.height);
        Sobel(img_data);
    };

</script>

</BODY>
</HTML>
